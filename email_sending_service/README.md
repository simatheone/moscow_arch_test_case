# Задание №2
## Микросервис для отправки email сообщений

## Оглавление

- [Задание №2](#задание-2)
  - [Микросервис для отправки email сообщений](#микросервис-для-отправки-email-сообщений)
  - [Оглавление](#оглавление)
  - [Задание](#задание)
  - [Запуск проекта](#запуск-проекта)
  - [Настройка `crontab`](#настройка-crontab)
    - [Проверка наличия cron в системе](#проверка-наличия-cron-в-системе)
    - [Создание и заполнение файла `cron_job`](#создание-и-заполнение-файла-cron_job)
    - [Редактирование глобального файла с заданиями `crontab -e`](#редактирование-глобального-файла-с-заданиями-crontab--e)
    - [Запуск `cron_job`](#запуск-cron_job)
  - [Логирование](#логирование)

## Задание
Требуется создать микросервис, который каждое **утро в 8:00** отправляет пользователям сообщение о задачах.

Ответ должен содержать в себе Python код отправки email оповещения, а также настройки сервера для ежедневного запуска скрипта.

## Запуск проекта

Для запуска проекта необходимо:

1. Клонирвать репозиторий:
```bash
https://github.com/simatheone/moscow_arch_test_case.git
```

2. Перейти директорию `email_sending_service/`:
```bash
cd email_sending_service/
```

3. Выполнить установку виртуального окружения и активировать его:
```bash
python3 -m venv venv

для bash/zsh:
source venv/bin/activate

для Windows:
venv\Scripts\activate.bat
```

4. Обновить `pip` и выполнить установку зависимостей из `requirements.txt`:
```bash
pip3 install --upgrate pip
pip3 install -r requirements.txt
```

5. Создать файл `.env`:

```bash
для bash/zsh:
touch .env
```
> Пример заполнения `.env` файла смотри в файле `.env.example`

6. Выполнить миграции:
```bash
alembic upgrade head
```

7. Заполнить базу тестовыми данными выполнив команду:
```bash
python3 scripts/seed_db.py
```

8. Для отчистки базы данных можно выполнить:
```bash
python3 scripts/clear_db.py
```
> Удаляются данные из таблиц "Task", "User"

[:top: Вернуться к оглавлению](#оглавление)

## Настройка `crontab`
Необходимо убедитсья, что на вашей машине установлен `cron`.

### Проверка наличия cron в системе
Выполните команду:
```bash
which cron
```

Результат будет примерно таким:
```bash
/usr/sbin/cron
```
Если же результат отличается, то ищите как установить cron на вашей OS. На линукс это примерно может быть так:
```bash
sudo apt-get update
sudo apt-get install cron
```

Убедитесь, что cron запущен. Выполните команду:
```bash
sudo service cron status
```
Если в терминале вы видете что-то подобное:
```bash
* cron is not running
```

Выполните запуск cron:
```bash
sudo service cron start
```

Есть два вариант настройки:
- создать свой файл с заданием `cron_job.crontab`, заполнить его и при вызове crontab указать путь до файла `cron_job.crontab`;
- редактировать глобальный файл с заданиями `crontab -e`.

> При втором варианте при удалении задания все настройки теряются.

---

### Создание и заполнение файла `cron_job`
В директории `email_sending_service/` создать файл `cron_job.crontab`:
```bash
для bash/zsh
touch cron_job.crontab
```
> Название файла может быть любым, не обязательно `cron_job`

Отредактировать файл добавив в него:
```bash
HOME=/home/<youruser>/<path>/<to>/<project>/moscow_arch_test_case/email_sending_service/
# The job starts everyday at 08:00
0 8 * * * /home/<youruser>/<path>/<to>/<project>/email_sending_service/venv/bin/python3 /home/<youruser>/<path>/<to>/<project>/email_sending_service/run.py
```
> `0 8 * * *` - означает, что скрипт будет запускаться каждый день в **8:00 утра**.

> вместо `<youruser>` - указать вашего пользователя

> вместо `/<path>/<to>/<project>/` - указать путь до директории `email_sending_service/`

Запуск `cron_job` [смотри далее](#запуск-cron_job).

[:top: Вернуться к оглавлению](#оглавление)

---

### Редактирование глобального файла с заданиями `crontab -e`

В терминале выполнить команду:
```bash
crontab -e
```

Выбрать удобный файловый редактор и внутри файла добавить:
```bash
HOME=/home/<youruser>/<path>/<to>/<project>/moscow_arch_test_case/email_sending_service/
0 8 * * * /home/<youruser>/<path>/<to>/<project>/email_sending_service/venv/bin/python3 /home/<youruser>/<path>/<to>/<project>/email_sending_service/run.py
```
> `0 8 * * *` - означает, что скрипт будет запускаться каждый день в **8:00 утра**.

> вместо `<youruser>` - указать вашего пользователя

> вместо `/<path>/<to>/<project>/` - указать путь до директории `email_sending_service/`

Сохранить изменения и выйти из редактора. При данном методе задание, описанное в файле, автоматически начнет выполняться.

Проверить, что ваша задача находится в работе можно с помощью команды:
```bash
crontab -l
```
Удалить задачу можно с помощью команды:
```bash
crontab -r
```
> при удалении никакого вывода в консоли не будет (удаляется молча)

Для пользователей `masOS`. Если после настройки `cron` не выполяются задачи, убедитесь, что у `cron` есть полный доступ к диску.
Рекомендую ознакомиться со [статьей](https://dccxi.com/posts/crontab-not-working-catalina/)

Для проверки работоспособности сервеса в настройках **crontab** вместо `0 8 * * * `, можно указать `* * * * *`. Задания будут отправляться на почту каждую минуту (при условии, что вы заполнили базу тестовыми данными и указали почту, на которую хотите получать письмо).

[:top: Вернуться к оглавлению](#оглавление)

---

### Запуск `cron_job`
После того как вы задали необходимые параметры, можно выполнить запуск задания.

Для этого необходимо в терминали выполнить команду:

```bash
crontab /home/<youruser>/<path>/<to>/<project>/email_sending_service/cron_job.crontab
```
> вместо `<youruser>` - указать вашего пользователя
> вместо `/<path>/<to>/<project>/` - указать путь до директории `email_sending_service/`

Проверить, что ваша задача находится в работе можно с помощью команды:
```bash
crontab -l
```
Удалить задачу можно с помощью команды:
```bash
crontab -r
```
> при удалении никакого вывода в консоли не будет (удаляется молча)

Для пользователей `masOS`. Если после настройки `cron` не выполяются задачи, убедитесь, что у `cron` есть полный доступ к диску.
Рекомендую ознакомиться со [статьей](https://dccxi.com/posts/crontab-not-working-catalina/)

Для проверки работоспособности сервеса в настройках **cron_job** вместо `0 8 * * * `, можно указать `* * * * *`. Задания будут отправляться на почту каждую минуту (при условии, что вы заполнили базу тестовыми данными и указали почту, на которую хотите получать письмо).

[:top: Вернуться к оглавлению](#оглавление)

## Логирование

Для сервиса настроено логирование. Логи сохраняются в файл `main_logs.log`, директория `/microservice/logs/`. Уровень логирования **INFO**.
